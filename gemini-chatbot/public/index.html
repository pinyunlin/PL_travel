<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini Chatbot</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root { font-family: system-ui, -apple-system; }
    body { margin: 0; background: #f5f7fb; color: #111; }
    .app { max-width: 820px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
    header { padding: 16px 20px; font-weight: 700; background: white; box-shadow: 0 1px 8px rgba(0,0,0,.06); }
    #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; gap: 12px; flex-direction: column; }
    .bubble { padding: 12px 14px; border-radius: 14px; max-width: 80%; line-height: 1.5; }
    .user   { align-self: flex-end; background: #2563eb; color: white; white-space: pre-wrap; }
    .bot    { align-self: flex-start; background: #fff; border: 1px solid #e5e7eb; }
    .thinking { align-self: flex-start; display: flex; align-items: center; gap: 8px; padding: 10px; color: #4b5563; }
    .thinking .dots { display: flex; gap: 4px; }
    .thinking .dot { width: 8px; height: 8px; border-radius: 50%; background: #4b5563; animation: pulse 1.5s infinite ease-in-out; }
    .thinking .dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }
    /* Markdown æ¨£å¼ */
    .bot p { margin: 0 0 10px 0; }
    .bot p:last-child { margin-bottom: 0; }
    .bot pre { background: #f1f5f9; padding: 8px; border-radius: 6px; overflow-x: auto; }
    .bot code { font-family: monospace; background: #f1f5f9; padding: 2px 4px; border-radius: 4px; }
    .bot pre code { padding: 0; background: none; }
    .bot ul, .bot ol { margin-top: 0; margin-bottom: 10px; padding-left: 20px; }
    .bot blockquote { margin-left: 0; padding-left: 10px; border-left: 3px solid #e5e7eb; color: #4b5563; }
    form { display: flex; gap: 8px; padding: 16px; background: white; box-shadow: 0 -1px 8px rgba(0,0,0,.06); }
    input, textarea, button { font: inherit; }
    #msg { flex: 1; resize: vertical; min-height: 48px; max-height: 160px; padding: 10px 12px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; }
    button { padding: 10px 16px; border-radius: 10px; border: none; background: #111827; color: #fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; color: #6b7280; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="app">
    <header>ğŸ’¬ Gemini Chatbot</header>
    <div id="chat"></div>
    <form id="form">
      <textarea id="msg" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒæŒ‰ Enter é€å‡ºï¼ˆShift+Enter æ›è¡Œï¼‰"></textarea>
      <button id="send" type="submit">é€å‡º</button>
    </form>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const form = document.getElementById('form');
    const msgEl = document.getElementById('msg');
    const sendBtn = document.getElementById('send');

    // å°è©±æ­·å²å­˜åœ¨å‰ç«¯ï¼ˆæœ€ç°¡å–®åšæ³•ï¼‰
    // å½¢å¦‚ï¼š[{ role: 'user'|'model', text: '...' }]
    const history = [];


    
    function addBubble(role, text) {
      const div = document.createElement('div');
      div.className = `bubble ${role === 'user' ? 'user' : 'bot'}`;
      
      // å°æ©Ÿå™¨äººå›å¾©ä½¿ç”¨ Markdown è§£æ
      if (role === 'model' || role === 'bot') {
        div.innerHTML = marked.parse(text);
      } else {
        div.textContent = text; // ä½¿ç”¨è€…è¨Šæ¯ä¾ç„¶ä½¿ç”¨ç´”æ–‡æœ¬
      }
      
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return div;
    }
    
    // æ·»åŠ "æ­£åœ¨æ€è€ƒ"çš„å‹•ç•«æŒ‡ç¤º
    function addThinkingIndicator() {
      const div = document.createElement('div');
      div.className = 'thinking';
      div.innerHTML = `
        <span>AIæ€è€ƒä¸­</span>
        <div class="dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      `;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return div;
    }
    
    // æ‰“å­—æ©Ÿæ•ˆæœé¡¯ç¤ºæ–‡å­—
    function typewriterEffect(text, element, speed = 20) {
      // å…ˆä½¿ç”¨ Markdown è§£ææ–‡æœ¬
      const parsedHTML = marked.parse(text);
      
      // å‰µå»ºä¸€å€‹è‡¨æ™‚å®¹å™¨ä»¥ç²å–ç´”æ–‡æœ¬å’ŒHTMLæ¨™ç±¤
      const tempContainer = document.createElement('div');
      tempContainer.innerHTML = parsedHTML;
      
      // åˆå§‹åŒ–é¡¯ç¤ºå…§å®¹
      element.innerHTML = '';
      
      // é¡¯ç¤ºHTMLç‰ˆæœ¬ï¼Œä½†è¨­ç½®é€æ˜åº¦ç‚º0
      const fullTextElement = document.createElement('div');
      fullTextElement.innerHTML = parsedHTML;
      fullTextElement.style.opacity = '0';
      fullTextElement.style.position = 'absolute';
      fullTextElement.style.pointerEvents = 'none';
      element.appendChild(fullTextElement);
      
      // å‰µå»ºç”¨æ–¼æ‰“å­—æ•ˆæœçš„å…ƒç´ 
      const typingElement = document.createElement('div');
      element.appendChild(typingElement);
      
      let currentText = '';
      const textContent = tempContainer.textContent;
      let charIndex = 0;
      
      const typeNextChar = () => {
        if (charIndex < textContent.length) {
          currentText += textContent[charIndex];
          // ä½¿ç”¨è‡¨æ™‚è§£æä¾†æ‰¾åˆ°å°æ‡‰çš„HTML
          const tempEl = document.createElement('div');
          tempEl.textContent = currentText;
          typingElement.innerHTML = marked.parse(tempEl.textContent);
          charIndex++;
          chatEl.scrollTop = chatEl.scrollHeight;
          
          // ç¹¼çºŒæ‰“å­—
          setTimeout(typeNextChar, speed);
        } else {
          // å®Œæˆå¾Œé¡¯ç¤ºå®Œæ•´çš„HTMLç‰ˆæœ¬ï¼ˆåŒ…å«æ ¼å¼ï¼‰
          element.innerHTML = parsedHTML;
          chatEl.scrollTop = chatEl.scrollHeight;
        }
      };
      
      // é–‹å§‹æ‰“å­—æ•ˆæœ
      typeNextChar();
    }

    // åˆå§‹æ­¡è¿
    addBubble('model', 'æ­¡è¿ä½¿ç”¨å èˆˆgemiï¼Œæœ¬ç³»çµ±æä¾›å°ˆæ¥­çš„å æ˜Ÿé‹å‹¢è©¢å•æœå‹™ã€‚æ‚¨å¯ä»¥è«®è©¢æ˜Ÿç›¤è§£æã€è¡Œæ˜Ÿç›¸ä½ã€æ„Ÿæƒ…é‹å‹¢æˆ–è·æ¥­ç™¼å±•ç­‰å•é¡Œã€‚');

    // å¿«é€Ÿå›æ‡‰è¨Šæ¯ï¼Œå¯æ ¹æ“šä½¿ç”¨è€…å¸¸å•çš„å•é¡Œé…ç½®
    const quickResponses = {
      greetings: [
        "æ‚¨å¥½ï¼æˆ‘æ˜¯å èˆˆgemiï¼Œå¾ˆé«˜èˆˆèƒ½ç‚ºæ‚¨æä¾›å æ˜Ÿè«®è©¢æœå‹™ï¼Œæˆ‘æ­£åœ¨åˆ†ææ‚¨çš„å•é¡Œ...",
        "æ­¡è¿ä½¿ç”¨å æ˜Ÿæœå‹™ï¼Œæˆ‘æ­£åœ¨æ€è€ƒå¦‚ä½•æœ€æº–ç¢ºåœ°å›ç­”æ‚¨çš„å•é¡Œ...",
        "æ„Ÿè¬æ‚¨çš„è€å¿ƒç­‰å¾…ï¼Œæˆ‘æ­£åœ¨ç¶œåˆæ˜Ÿè±¡å› ç´ ç‚ºæ‚¨æä¾›è§£ç­”..."
      ],
      default: [
        "æˆ‘æ­£åœ¨è§£ææ˜Ÿç›¤æ•¸æ“šï¼Œéœ€è¦ä¸€é»æ™‚é–“...",
        "æ­£åœ¨åˆ†æè¡Œæ˜Ÿç›¸ä½ï¼Œå¾ˆå¿«å°±èƒ½çµ¦æ‚¨è§£ç­”...",
        "æˆ‘æ­£åœ¨æ€è€ƒå¦‚ä½•ç‚ºæ‚¨æä¾›æœ€æœ‰åƒ¹å€¼çš„å æ˜Ÿåˆ†æ..."
      ]
    };
    
    // ç²å–å¿«é€Ÿå›æ‡‰
    function getQuickResponse(message) {
      const lowerMsg = message.toLowerCase();
      
      // æª¢æŸ¥æ˜¯å¦æ˜¯å•å€™
      if (lowerMsg.includes('ä½ å¥½') || lowerMsg.includes('å“ˆå›‰') || lowerMsg.includes('å—¨') || 
          lowerMsg.includes('hi') || lowerMsg.includes('hello')) {
        return quickResponses.greetings[Math.floor(Math.random() * quickResponses.greetings.length)];
      }
      
      // é è¨­å›æ‡‰
      return quickResponses.default[Math.floor(Math.random() * quickResponses.default.length)];
    }

    // è¡¨å–®é€å‡º
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = msgEl.value.trim();
      if (!text) return;

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addBubble('user', text);
      history.push({ role: 'user', text });

      // æ¸…ç©ºè¼¸å…¥æ¡†
      msgEl.value = '';
      msgEl.focus();
      sendBtn.disabled = true;

      // é¡¯ç¤ºæ€è€ƒæŒ‡ç¤ºå™¨
      const thinkingIndicator = addThinkingIndicator();
      
      // è¨­ç½®ä¸€å€‹å®šæ™‚å™¨ï¼Œåœ¨ 1 ç§’å¾Œé¡¯ç¤ºå¿«é€Ÿå›æ‡‰
      const quickResponseTimeout = setTimeout(() => {
        // å¦‚æœ AI é‚„æ²’å›è¦†ï¼Œé¡¯ç¤ºå¿«é€Ÿå›æ‡‰
        thinkingIndicator.remove();
        
        // ç²å–ä¸¦é¡¯ç¤ºå¿«é€Ÿå›æ‡‰
        const quickResponse = getQuickResponse(text);
        const quickBubble = document.createElement('div');
        quickBubble.className = 'bubble bot';
        quickBubble.setAttribute('data-quick-response', 'true');
        chatEl.appendChild(quickBubble);
        
        // ä½¿ç”¨è¼ƒå¿«çš„æ‰“å­—æ©Ÿæ•ˆæœé¡¯ç¤ºå¿«é€Ÿå›æ‡‰
        typewriterEffect(quickResponse, quickBubble, 10);
      }, 1000);
      
      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ history, message: text })
        });
        
        // æ¸…é™¤å¿«é€Ÿå›æ‡‰å®šæ™‚å™¨
        clearTimeout(quickResponseTimeout);
        
        // ç§»é™¤æ€è€ƒæŒ‡ç¤ºå™¨ï¼ˆå¦‚æœé‚„å­˜åœ¨ï¼‰
        if (thinkingIndicator.parentNode) {
          thinkingIndicator.remove();
        }
        
        // ç§»é™¤å¿«é€Ÿå›æ‡‰ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const quickResponseBubble = chatEl.querySelector('[data-quick-response="true"]');
        if (quickResponseBubble) {
          quickResponseBubble.remove();
        }
        
        const data = await resp.json();
        if (data?.reply) {
          history.push({ role: 'model', text: data.reply });
          
          // å‰µå»ºå›æ‡‰æ°£æ³¡ä½†ä¸ç›´æ¥é¡¯ç¤ºå…§å®¹
          const bubble = document.createElement('div');
          bubble.className = 'bubble bot';
          chatEl.appendChild(bubble);
          
          // ä½¿ç”¨æ‰“å­—æ©Ÿæ•ˆæœé¡¯ç¤ºå›æ‡‰
          typewriterEffect(data.reply, bubble);
        } else {
          addBubble('model', `ï¼ˆç™¼ç”ŸéŒ¯èª¤ï¼‰${data?.error || 'Unknown error'}`);
        }
      } catch (err) {
        // æ¸…é™¤å¿«é€Ÿå›æ‡‰å®šæ™‚å™¨
        clearTimeout(quickResponseTimeout);
        
        // ç§»é™¤æ€è€ƒæŒ‡ç¤ºå™¨ï¼ˆå¦‚æœé‚„å­˜åœ¨ï¼‰
        if (thinkingIndicator.parentNode) {
          thinkingIndicator.remove();
        }
        
        // ä¿ç•™å¿«é€Ÿå›æ‡‰ï¼ˆå¦‚æœå·²é¡¯ç¤ºï¼‰ï¼Œåªæ·»åŠ éŒ¯èª¤è¨Šæ¯
        const quickResponseBubble = chatEl.querySelector('[data-quick-response="true"]');
        if (!quickResponseBubble) {
          addBubble('model', `ï¼ˆé€£ç·šå¤±æ•—ï¼‰${err.message}`);
        } else {
          addBubble('model', `å¾ˆæŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†é€£ç·šå•é¡Œï¼š${err.message}`);
        }
      } finally {
        sendBtn.disabled = false;
      }
    });

    // Enter é€å‡ºã€Shift+Enter æ›è¡Œ
    msgEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>
